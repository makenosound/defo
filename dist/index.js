"use strict";function renderTree({prefix:e,scope:t,views:r}){Object.keys(r).forEach(o=>{const s=`data-${e}-${dasherize(o)}`;let a=Array.prototype.slice.call(t.querySelectorAll(`[${s}]`));t.hasAttribute(s)&&(a=[t].concat(a)),a.forEach(t=>{renderNode(t,e,r,o)})})}function renderNode(e,t,r,o){if(e._defoUpdate&&e._defoUpdate[o])return;const s=r[o];if(!s)return;const a=s(e,parseProps(e.dataset[keyForDataset(t,o)]));e._defoUpdate=e._defoUpdate||{},e._defoDestroy=e._defoDestroy||{},e._defoUpdate[o]=unwrapUpdate(a),e._defoDestroy[o]=unwrapDestroy(a,e,o)}function unwrapUpdate(e){return function(t,r){t=t?parseProps(t):t,r=r?parseProps(r):r,Promise.resolve(e).then(e=>{e.update&&e.update(t,r)})}}function unwrapDestroy(e,t,r){return function(){Promise.resolve(e).then(e=>{e.destroy&&(e.destroy(),delete t._defoUpdate[r],delete t._defoDestroy[r])})}}function keyForDataset(e,t){return`${e}${t.charAt(0).toUpperCase()+t.slice(1)}`}function dasherize(e){return e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}function parseProps(e){return/^({|\[)/.test(e)&&(e=JSON.parse(e)),e}function observe({prefix:e,scope:t,views:r}){renderTree({prefix:e,scope:t,views:r});const o=new window.MutationObserver(t=>{t.forEach(t=>{const o=t.target;if("attributes"===t.type&&attributeNameMatchesPrefix(t.attributeName,e)){const s=attributeNameToViewName(t.attributeName);o.hasAttribute(t.attributeName)?null!==t.oldValue?o._defoUpdate[s](o.getAttribute(t.attributeName),t.oldValue):renderNode(o,e,r,s):o._defoDestroy[s]()}else"childList"===t.type&&(Array.prototype.slice.call(t.removedNodes).filter(e=>!e.TEXT_NODE).filter(t=>hasDatasetKeysMatchingPrefix(t,e)).forEach(e=>{Object.keys(e._defoDestroy).forEach(t=>{e._defoDestroy[t]()})}),Array.prototype.slice.call(t.addedNodes).filter(e=>!e.TEXT_NODE).forEach(t=>{Promise.resolve(t).then(t=>{renderTree({prefix:e,scope:t,views:r})})}))})});return o.observe(t,{attributes:!0,attributeOldValue:!0,childList:!0,characterData:!1,subtree:!0}),o}function datasetKeysForPrefix(e,t){return Object.keys(e.dataset).filter(e=>0===e.indexOf(t))}function hasDatasetKeysMatchingPrefix(e,t){return datasetKeysForPrefix(e,t).length>0}function attributeNameMatchesPrefix(e,t){return 0===e.indexOf(`data-${t}`)}function attributeNameToViewName(e){return e.split("-").slice(2).map((e,t)=>t>0?e.charAt(0).toUpperCase()+e.slice(1):e).join("")}function registerViews(e,t){return Object.assign(Object.assign({},e),t)}function unregisterViews(e,t){const r={};return Object.keys(e).forEach(o=>{-1===t.indexOf(o)&&(r[o]=e[o])}),r}function defo({prefix:e="defo",scope:t=document.documentElement,views:r={}}={}){observe({prefix:e,scope:t,views:r});return{registerViews:e=>r=registerViews(r,e),unregisterViews:e=>r=unregisterViews(r,e)}}module.exports=defo;
